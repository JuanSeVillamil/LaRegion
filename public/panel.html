<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Administrador</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Panel de AdministraciÃ³n</h1>
  <button id="btn-logout">Cerrar sesiÃ³n</button>
  <button id="btn-agregar">âž• Agregar nuevo certificado</button>

  <hr>

  <h2>Lista de nÃºmeros registrados</h2>
  <table border="1" id="tabla-estados">
    <thead>
      <tr>
        <th>Eliminar</th>
        <th>NÃºmero</th>
        <th>Estado</th>
        <th>Contratante</th>
        <th>Beneficiario</th>
        <th>Ciudad</th>
        <th>Fecha ExpediciÃ³n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // ðŸ”¹ Verificar sesiÃ³n
      try {
        const res = await fetch('/verificar-sesion', { credentials: 'include' });
        const data = await res.json();
        if (!data.activa) {
          alert('SesiÃ³n no activa. Por favor inicia sesiÃ³n.');
          window.location.href = 'login.html';
          return;
        }
        cargarNumeros();
      } catch (error) {
        console.error('Error al verificar sesiÃ³n:', error);
        alert('Error al verificar sesiÃ³n. Redirigiendo al login.');
        window.location.href = 'login.html';
      }

      // ðŸ”¹ BotÃ³n para ir a certificado.html
      document.getElementById('btn-agregar').addEventListener('click', () => {
        window.location.href = 'certificado.html';
      });

      // ðŸ”¹ Logout
      document.getElementById('btn-logout').addEventListener('click', async () => {
        try {
          const res = await fetch('/logout', { method: 'POST', credentials: 'include' });
          const data = await res.json();
          if (data.mensaje) {
            alert('SesiÃ³n cerrada correctamente');
            window.location.href = 'login.html';
          }
        } catch (error) {
          console.error('Error al cerrar sesiÃ³n:', error);
          alert('No se pudo cerrar sesiÃ³n');
        }
      });
    });

    // ðŸ”¹ Cargar registros en tabla
    async function cargarNumeros() {
      try {
        const res = await fetch('/todos', { credentials: 'include' });
        const data = await res.json();

        const tbody = document.querySelector('#tabla-estados tbody');
        tbody.innerHTML = '';

        data.forEach(({ numero, estado, contratante, beneficiario, contratante_ciudad, fecha_expedicion }) => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td><button onclick="eliminarNumero('${numero}')">Eliminar</button></td>
            <td>${numero}</td>
            <td>${estado}</td>
            <td>${contratante || ''}</td>
            <td>${beneficiario || ''}</td>
            <td>${contratante_ciudad || ''}</td>
            <td>${fecha_expedicion ? fecha_expedicion.split('T')[0] : ''}</td>
          `;
          tbody.appendChild(fila);
        });
      } catch (error) {
        console.error('Error al cargar registros:', error);
        alert('No se pudieron cargar los registros');
      }
    }

    // ðŸ”¹ Eliminar un registro
    async function eliminarNumero(numero) {
      if (!confirm(`Â¿Seguro que quieres eliminar el nÃºmero ${numero}?`)) return;

      try {
        const res = await fetch('/eliminar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero }),
          credentials: 'include'
        });
        const data = await res.json();

        if (data.exito) {
          alert('NÃºmero eliminado correctamente');
          cargarNumeros();
        } else {
          alert('Error al eliminar nÃºmero: ' + (data.mensaje || ''));
        }
      } catch (error) {
        alert('Error al conectar con el servidor');
        console.error(error);
      }
    }
  </script>
</body>
</html>
