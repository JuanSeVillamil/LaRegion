<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Administrador</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Panel de Administraci√≥n</h1>
  <button id="btn-logout">Cerrar sesi√≥n</button>

  <!-- Formulario para agregar o actualizar un n√∫mero -->
  <form id="form-agregar">
    <input type="text" id="nuevo-numero" placeholder="N√∫mero" required>
    <select id="nuevo-estado">
      <option value="Aprobado">Aprobado</option>
      <option value="No aprobado">No aprobado</option>
    </select>
    <input type="text" id="nuevo-tomador" placeholder="Tomador">
    <input type="text" id="nuevo-asegurado" placeholder="Asegurado">
    <button type="submit">Agregar / Actualizar</button>
  </form>
  <p id="mensaje-agregar"></p>

  <hr>

  <!-- Formulario para cambiar contrase√±a -->
  <h2>Cambiar Contrase√±a</h2>
  <form id="form-cambiar-contrasena">
    <input type="password" id="contrasena-nueva" placeholder="Nueva contrase√±a" required />
    <button type="submit">Actualizar contrase√±a</button>
  </form>
  <p id="mensaje-contrasena"></p>

  <hr>

  <!-- Tabla de n√∫meros registrados -->
  <h2>Lista de n√∫meros registrados</h2>
  <table border="1" id="tabla-estados">
    <thead>
      <tr>
        <th>N√∫mero</th>
        <th>Estado actual</th>
        <th>Tomador</th>
        <th>Asegurado</th>
        <th>Nuevo estado</th>
        <th>Actualizar</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ‚úÖ Script unificado al final -->
  <script>
    // ‚úÖ Validar sesi√≥n antes de cualquier acci√≥n
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/verificar-sesion');
        const data = await res.json();

        if (!data.activa) {
          alert('Sesi√≥n no activa. Por favor inicia sesi√≥n.');
          window.location.href = 'login.html';
          return;
        }

        cargarNumeros();

        // Evento: agregar/actualizar n√∫mero
        document.getElementById('form-agregar').addEventListener('submit', async function (e) {
          e.preventDefault();
          const numero = document.getElementById('nuevo-numero').value;
          const estado = document.getElementById('nuevo-estado').value;
          const tomador = document.getElementById('nuevo-tomador').value;
          const asegurado = document.getElementById('nuevo-asegurado').value;

          const res = await fetch('/agregar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numero, estado, tomador, asegurado })
          });

          const data = await res.json();
          const mensaje = document.getElementById('mensaje-agregar');
          if (data.exito) {
            mensaje.innerText = 'N√∫mero agregado/actualizado correctamente';
            document.getElementById('form-agregar').reset();
            cargarNumeros();
          } else {
            mensaje.innerText = 'Error: ' + data.mensaje;
          }
        });

        // Evento: cambiar contrase√±a
        document.getElementById('form-cambiar-contrasena').addEventListener('submit', async e => {
          e.preventDefault();

          const contrasenaNueva = document.getElementById('contrasena-nueva').value.trim();
          const mensaje = document.getElementById('mensaje-contrasena');

          if (!contrasenaNueva) {
            mensaje.style.color = 'red';
            mensaje.textContent = 'Ingrese una nueva contrase√±a.';
            return;
          }

          try {
            const res = await fetch('/cambiar-contrasena', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ usuario: 'admin', contrasenaNueva })
            });
            const data = await res.json();

            if (data.exito) {
              mensaje.style.color = 'green';
              mensaje.textContent = data.mensaje;
              document.getElementById('form-cambiar-contrasena').reset();
              cargarNumeros(); // üîÑ Volver a cargar la tabla
            } else {
              mensaje.style.color = 'red';
              mensaje.textContent = data.mensaje || 'Error al actualizar contrase√±a.';
            }
          } catch (error) {
            mensaje.style.color = 'red';
            mensaje.textContent = 'Error al conectar con el servidor.';
            console.error(error);
          }
        });

        // Bot√≥n cerrar sesi√≥n
        document.getElementById('btn-logout').addEventListener('click', async () => {
          try {
            const res = await fetch('/logout', { method: 'POST', credentials: 'include' });
            const data = await res.json();

            if (data.mensaje) {
              alert('Sesi√≥n cerrada correctamente');
              window.location.href = 'login.html';
            }
          } catch (error) {
            console.error('Error al cerrar sesi√≥n:', error);
            alert('No se pudo cerrar sesi√≥n');
          }
        });

      } catch (error) {
        console.error('Error al verificar sesi√≥n:', error);
        alert('Error al verificar sesi√≥n. Redirigiendo al login.');
        window.location.href = 'login.html';
      }
    });

    // Cargar todos los n√∫meros en la tabla
    async function cargarNumeros() {
      const res = await fetch('/todos');
      const data = await res.json();

      const tbody = document.querySelector('#tabla-estados tbody');
      tbody.innerHTML = '';

      data.forEach(({ numero, estado, tomador, asegurado }) => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${numero}</td>
          <td>${estado}</td>
          <td><input type="text" class="input-tomador" value="${tomador || ''}"></td>
          <td><input type="text" class="input-asegurado" value="${asegurado || ''}"></td>
          <td>
            <select>
              <option value="Aprobado" ${estado === 'Aprobado' ? 'selected' : ''}>Aprobado</option>
              <option value="No aprobado" ${estado === 'No aprobado' ? 'selected' : ''}>No aprobado</option>
            </select>
          </td>
          <td><button onclick="actualizarEstado('${numero}', this)">Actualizar</button></td>
        `;
        tbody.appendChild(fila);
      });
    }

    // Actualizar estado desde la tabla
    async function actualizarEstado(numero, btn) {
      const fila = btn.closest('tr');
      const nuevoEstado = fila.querySelector('select').value;
      const nuevoTomador = fila.querySelector('.input-tomador').value;
      const nuevoAsegurado = fila.querySelector('.input-asegurado').value;

      const res = await fetch('/agregar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero, estado: nuevoEstado, tomador: nuevoTomador, asegurado: nuevoAsegurado })
      });

      const data = await res.json();
      if (data.exito) {
        alert("Datos actualizados correctamente");
        cargarNumeros();
      } else {
        alert("Error al actualizar datos");
      }
    }

  </script>
</body>
</html>
